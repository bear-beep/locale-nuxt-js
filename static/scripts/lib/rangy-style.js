define(["rangy-core"],function(m){return{isSameStyle:e,getTransTargetAttrs:n,transferStyleToSpan:b,restoreDivStyle:k,formatTarget:j};function n(p,o){var s=window.sameStyleData;var q=' class="textarea_container ';p=p.replace(/(^\s*)|(\s*$)/g,"");p=g(p);var r=e(p);if(!s){s=window.sameStyleData={}}if(r){s[o.seg_id]=r;if(!o.last_targettxt){q+=r.classNameStr+' "';if(r.color){q+=' style="color:'+r.color+'" ';q+=' realcolor="'+r.realcolor+'"'}}else{q+='"'}if(p.indexOf("fontLink")>-1||p.indexOf("fontHide")>-1){q+=f(p)}}else{q+='"'}return q}function e(q){var t,u,r=undefined,p=false,s=/<span(.*?)class="(.*?)"([^>]*)/g,o=q.match(s);if(o&&o.length==1){t=RegExp.$2;t=t.replace(/(highlights)|(fontText)|(fontHide)/g,"");t=t.replace(/(^\s*)|(\s*$)/g,"");if(t==""){return p}if(t.indexOf("fontColor")!=-1){q.match(/color:(.*?)"/);r=RegExp.$1;q.match(/realcolor="(.*?)"/g);u=RegExp.$1}t+=" sameStyle";p={classNameStr:t,color:r,realcolor:u}}return p}function g(o){var q,s=$("<div></div>");s.html(o);q=s.children();if(q.length>0){var r=q.eq(0),p=q.eq(q.length-1);if(r.html().replace(/\s/g,"")==""){r.remove()}if(p.html().replace(/\s/g,"")==""){p.remove()}}return s.html()}function b(q,p){var o,r;if(!q&&p){q=d(p)}if(q&&q.hasClass("sameStyle")){o=q.children("span");if(o.length>0){r=h(q);o.addClass(r.classNameStr);o.css("color",r.color);o.attr("realcolor",r.realcolor);i(q,o);q.removeClass(r.classNameStr);q.removeClass("sameStyle");q.css("color","")}}}function i(t,o){var q,s,r=["type","content","insured","num"];if(t.hasClass("fontLink")||t.hasClass("fontHide")){for(var p=0;p<r.length;p++){q=r[p];s=t.attr(q);o.attr(q,s)}}}function f(q){var s,u,p="",o=$(q),t=["type","content","insured","num"];for(var r=0;r<t.length;r++){s=t[r];u=o.attr(s);if(u){p+=s+'="'+u+'" '}}return p}function h(q){var p,o,r,s;p=q.attr("class");p=p.replace(/(sameStyle)|(textarea_container)/g,"");p=p.replace(/(^\s*)|(\s*$)/g,"");r=p.split(" ");o=q.css("color");s=q.attr("realcolor");return{classNames:r,classNameStr:p,color:o,realcolor:s}}function k(p){var q,o=p.parents("tr.segment").data("segment");q=window.sameStyleData[o.seg_id];if(p&&q){p.addClass(q.classNameStr);p.addClass("sameStyle");if(q.color){p.css("color",q.color);p.attr("realColor",q.realcolor)}}}function d(p){var o=$(p.commonAncestorContainer);if(!o.is("div")){o=o.parents("div.textarea_container")}return o}function j(C){var x=C.find("em.mark"),v=C.find("u"),A=C.find("q");var s,E,F,r,G,K,B,z,y=null,q=C.contents(),w=q.clone(),u=false;var p="";if(x.length>0||v.length>0||A.length>0){for(var D=0;D<q.length;D++){var J=$(q[D]);if(!J.hasClass("tagWrap")){var o=J.text();J.text(o)}}return}if(m.getSelection()){B=m.getSelection().getRangeAt(0);z=l(B);if(B){if(B.endOffset!=B.startOffset){u=true}}}for(var I=0;I<w.length;I++){s=q.eq(I);if(s[0].nodeType==3){s.wrap('<span class="fontText"></span>')}else{if(s.html()==""){s.remove()}else{if(s.is("span")){if(!(s.hasClass("fontText")||s.hasClass("tagWrap"))){s.removeAttr("style class")}E=s.contents();for(var H=0;H<E.length;H++){F=E.eq(H);G=null;if(F.is("img")){G=s.clone();G.html(F)}else{if(F[0].nodeType==3&&u){}else{if(F.is("em")&&F.hasClass("highLight")){K=F.text();G=s.clone();G.text(K);F.remove()}else{if(F.html()==""){F.remove()}else{if(F.is("span")&&F.hasClass("fontText")){G=F;F.remove()}else{K=F.text();G=s.clone();if(G.hasClass("tagWrap")){delete G[0].dataset.db;delete G[0].dataset.fw;delete G[0].dataset.no;delete G[0].dataset.notag}G.removeClass("tagWrap single double start end").addClass("fontText");G.text(K);y=G;F.remove()}}}}}if(G){s.before(G)}}}else{if(s.is("div")&&s.find(".fontText,.tagWrap")){s.find("br").remove();var t=s.html();s.replaceWith(t)}else{K=s.text();G=$('<span class="fontText"></span>');G.text(K);s.replaceWith(G);y=G}}}}}if(y){z=y?y[0]:z;r=m.getSelection().getRangeAt(0);if(B&&r&&z){if(!a(B)&&!c(B,r)&&z){B.setEndAfter(z);B.collapse(false);B.select()}}}return C}function l(o){if(!o){return null}var r,q=o.endContainer,p=o.endOffset;if(q.nodeType!=3){r=(p-1>=0)?p-1:0;q=q.childNodes[r]}return q}function a(o){var p=o.startContainer;if(o.collapsed&&p.nodeType==3&&$(p).parents("body").length>0){o.setEnd(p,o.endOffset);o.select();return true}return false}function c(p,o){if(p.startContainer==o.startContainer&&p.endContainer==o.endContainer&&p.startOffset==o.startOffset&&p.endOffset==o.endOffset){return true}return false}});